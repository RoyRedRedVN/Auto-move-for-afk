--// Load Rayfield UI \\--
local Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/SiriusSoftwareLtd/Rayfield/main/source.lua'))()

--// Services \\--
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local RootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:FindFirstChildOfClass("Humanoid")

--// Variables \\--
local autoAvoidEnabled = false
local avoidDistance = 15
local backDistance = 10
local patrolRadius = 20
local patrolSegments = 3
local patrolPause = 1
local replyKeywords = {"plss","pls"}
local replyText = "no"

--// Create Rayfield UI \\--
local Window = Rayfield:CreateWindow({Name = "NPC Patrol + Né Player"})

local MainTab = Window:CreateTab("Main")
local SettingsTab = Window:CreateTab("Settings")

MainTab:CreateToggle({
    Name = "Auto Né Player",
    CurrentValue = false,
    Flag = "AutoAvoid",
    Callback = function(state)
        autoAvoidEnabled = state
    end
})

--// Settings sliders \\--
SettingsTab:CreateSlider({
    Name = "Khoảng cách né",
    Range = {5,50},
    Increment = 1,
    Suffix = "studs",
    CurrentValue = avoidDistance,
    Flag = "AvoidDistance",
    Callback = function(value)
        avoidDistance = value
    end
})

SettingsTab:CreateSlider({
    Name = "Độ lùi khi né",
    Range = {5,30},
    Increment = 1,
    Suffix = "studs",
    CurrentValue = backDistance,
    Flag = "BackDistance",
    Callback = function(value)
        backDistance = value
    end
})

SettingsTab:CreateSlider({
    Name = "Bán kính patrol",
    Range = {10,50},
    Increment = 1,
    Suffix = "studs",
    CurrentValue = patrolRadius,
    Flag = "PatrolRadius",
    Callback = function(value)
        patrolRadius = value
    end
})

SettingsTab:CreateInput({
    Name = "Reply Keywords (comma separated)",
    PlaceholderText = "plss,pls,...",
    Text = table.concat(replyKeywords,","),
    Flag = "ReplyKeywords",
    Callback = function(input)
        replyKeywords = {}
        for word in string.gmatch(input, "[^,]+") do
            table.insert(replyKeywords, word:lower())
        end
    end
})

SettingsTab:CreateInput({
    Name = "Reply Text",
    PlaceholderText = "no",
    Text = replyText,
    Flag = "ReplyText",
    Callback = function(input)
        replyText = input
    end
})

--// Utils \\--
local function isPlayerNearby(distance)
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            if (plr.Character.HumanoidRootPart.Position - RootPart.Position).Magnitude <= distance then
                return plr
            end
        end
    end
    return nil
end

local function moveAwayFromPlayer(plr)
    if plr and Humanoid then
        local dir = (RootPart.Position - plr.Character.HumanoidRootPart.Position).Unit
        local targetPos = RootPart.Position + dir*backDistance
        Humanoid:MoveTo(targetPos)
    end
end

local function getPatrolPositions(origin, segments, radius)
    local positions = {}
    for i = 1, segments do
        local angle = math.random() * math.pi * 2
        table.insert(positions, origin + Vector3.new(math.cos(angle),0,math.sin(angle))*radius)
    end
    return positions
end

--// NPC Patrol Logic \\--
spawn(function()
    while true do
        local origin = RootPart.Position
        local patrolPoints = getPatrolPositions(origin, patrolSegments, patrolRadius)
        for _, point in ipairs(patrolPoints) do
            Humanoid:MoveTo(point)
            Humanoid.MoveToFinished:Wait()
            task.wait(patrolPause)
        end
        -- Quay về chỗ cũ
        Humanoid:MoveTo(origin)
        Humanoid.MoveToFinished:Wait()
        task.wait(patrolPause)
    end
end)

--// Auto Né player loop \\--
RunService.Heartbeat:Connect(function()
    if autoAvoidEnabled then
        local plr = isPlayerNearby(avoidDistance)
        moveAwayFromPlayer(plr)
    end
end)

--// Auto reply chat \\--
Players.PlayerChatted:Connect(function(plr,msg)
    for _, keyword in ipairs(replyKeywords) do
        if string.find(string.lower(msg), keyword) then
            LocalPlayer:Chat(replyText)
            break
        end
    end
end)

--// Respawn handler \\--
LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    RootPart = char:WaitForChild("HumanoidRootPart")
    Humanoid = char:FindFirstChildOfClass("Humanoid")
end)