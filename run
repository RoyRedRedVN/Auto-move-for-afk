--[[ ü¶Ö NPC Avoid Hub ‚Äî by Red GPT
   - Rayfield UI + auto save config
   - Anti-AFK (toggle)
   - Patrol NPC (2‚Äì3 ƒëo·∫°n r·ªìi quay l·∫°i)
   - Auto Avoid Player (Pathfinding, n√© t∆∞·ªùng/nh·∫£y)
   - Avoid Eye Contact (b·ªã nh√¨n ‚Üí quay h∆∞·ªõng kh√°c m∆∞·ª£t)
   - Auto reply (pls/plss => no)
]]

--// Load Rayfield (official)
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

--// Window + Config Saving
local Window = Rayfield:CreateWindow({
  Name = "ü¶Ö NPC Avoid Hub",
  LoadingTitle = "Eagle mode",
  LoadingSubtitle = "by Red GPT",
  Theme = "Default",
  ConfigurationSaving = {
     Enabled = true,
     FolderName = "RedHub",
     FileName = "NPC_Avoid_Config"
  }
})

--// Tabs
local Main = Window:CreateTab("Main")
local Settings = Window:CreateTab("Settings")

--// Services & locals
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local PathfindingService = game:GetService("PathfindingService")
local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")
local hum  = char:WaitForChild("Humanoid")

lp.CharacterAdded:Connect(function(c)
  char = c
  root = c:WaitForChild("HumanoidRootPart")
  hum  = c:WaitForChild("Humanoid")
end)

--// Defaults (will be overridden by saved config after LoadConfiguration)
local avoidDist, backDist = 15, 10
local patrolRadius, patrolSeg, patrolPause = 20, 3, 0.8
local replyKeys, replyTxt = {"plss","pls"}, "no"

--// Toggle states
local Toggles = {
  AntiAFK = false,
  AutoPatrol = false,
  AvoidPlayer = false,
  AvoidEye = true,
  AutoReply = true,
}

--// ===== Utils =====
local function nearPlayer(maxD)
  if not root then return end
  local closest, cd = nil, maxD or 9e9
  for _,p in ipairs(Players:GetPlayers()) do
    if p ~= lp and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
      local hrp = p.Character.HumanoidRootPart
      local d = (hrp.Position - root.Position).Magnitude
      if d < cd then closest, cd = p, d end
    end
  end
  return (closest and cd <= (maxD or avoidDist)) and closest or nil
end

local function isLookingAtMe(p)
  local hrp = p.Character and p.Character:FindFirstChild("HumanoidRootPart")
  if not hrp or not root then return false end
  local look = hrp.CFrame.LookVector
  local dir  = (root.Position - hrp.Position).Unit
  return look:Dot(dir) > 0.8 -- ‚Äú√°nh m·∫Øt s·∫Øt b√©n‚Äù ü¶Ö
end

-- nh·∫π, kh√¥ng gi·∫≠t (15 frames)
local function smoothRotateRandom()
  if not root then return end
  local targetYaw = math.random()*math.pi*2
  local startCFrame = root.CFrame
  local basePos = root.Position
  for i = 1, 15 do
    local alpha = i/15
    root.CFrame = CFrame.new(basePos) * CFrame.Angles(0, targetYaw*alpha, 0)
    RunService.Heartbeat:Wait()
  end
end

-- Pathfinding move (n√© t∆∞·ªùng/nh·∫£y qua). T·ª± ‚Äúspace‚Äù n·∫øu ƒëang Sit
local function MoveToTarget(targetPos)
  if not (hum and root and targetPos) then return end

  local path = PathfindingService:CreatePath({
    AgentRadius = 2,
    AgentHeight = 5,
    AgentCanJump = true,
    AgentJumpHeight = 10,
    AgentMaxSlope = 45,
  })

  path:ComputeAsync(root.Position, targetPos)
  if path.Status ~= Enum.PathStatus.Success and path.Status ~= Enum.PathStatus.Complete then
    -- fallback: ƒëi th·∫≥ng n·∫øu path fail
    hum:MoveTo(targetPos)
    hum.MoveToFinished:Wait()
    return
  end

  local waypoints = path:GetWaypoints()
  for _,wp in ipairs(waypoints) do
    if hum.Sit then
      hum:ChangeState(Enum.HumanoidStateType.GettingUp) -- nh∆∞ b·∫•m Space
      task.wait(0.2)
    end
    if wp.Action == Enum.PathWaypointAction.Jump then
      hum.Jump = true
    end
    hum:MoveTo(wp.Position)
    hum.MoveToFinished:Wait()
  end
end

-- Patrol points
local function randomInRadius(origin, radius)
  local a = math.random()*math.pi*2
  return origin + Vector3.new(math.cos(a),0,math.sin(a))*radius
end

--// ===== Loops =====
-- Avoid (throttle ƒë·ªÉ ƒë·ª° compute li√™n t·ª•c)
local lastAvoid = 0
RunService.Heartbeat:Connect(function()
  if not (hum and root) then return end
  if not Toggles.AvoidPlayer then return end
  if os.clock() - lastAvoid < 0.15 then return end
  lastAvoid = os.clock()

  local target = nearPlayer(avoidDist)
  if target then
    if Toggles.AvoidEye and isLookingAtMe(target) then
      smoothRotateRandom()
      return
    end
    local dir = (root.Position - target.Character.HumanoidRootPart.Position).Unit
    local dest = root.Position + dir * backDist
    MoveToTarget(dest)
  end
end)

-- Patrol loop (2‚Äì3 ƒëo·∫°n r·ªìi v·ªÅ ch·ªó c≈©)
task.spawn(function()
  while true do
    task.wait(0.25)
    if not (Toggles.AutoPatrol and hum and root) then continue end
    local origin = root.Position
    local segs = math.clamp(patrolSeg, 2, 3) -- ƒë√∫ng y√™u c·∫ßu 2‚Äì3 ƒëo·∫°n
    for i=1, segs do
      MoveToTarget(randomInRadius(origin, patrolRadius))
      task.wait(patrolPause)
    end
    MoveToTarget(origin)
    task.wait(patrolPause)
  end
end)

-- Auto reply
Players.PlayerChatted:Connect(function(p,msg)
  if not Toggles.AutoReply then return end
  local m = string.lower(tostring(msg or ""))
  for _,k in ipairs(replyKeys) do
    if m:find(k) then
      lp:Chat(replyTxt)
      break
    end
  end
end)

-- Anti AFK
local vu = game:GetService("VirtualUser")
lp.Idled:Connect(function()
  if Toggles.AntiAFK then
    vu:CaptureController()
    vu:ClickButton2(Vector2.new())
  end
end)

--// ===== UI =====
-- Toggles
Main:CreateToggle({Name="Anti AFK", Flag="AntiAFK", CurrentValue=Toggles.AntiAFK, Callback=function(v) Toggles.AntiAFK=v end})
Main:CreateToggle({Name="Auto Patrol (2‚Äì3 ƒëo·∫°n)", Flag="AutoPatrol", CurrentValue=Toggles.AutoPatrol, Callback=function(v) Toggles.AutoPatrol=v end})
Main:CreateToggle({Name="Avoid Players", Flag="AvoidPlayers", CurrentValue=Toggles.AvoidPlayer, Callback=function(v) Toggles.AvoidPlayer=v end})
Main:CreateToggle({Name="Avoid Eye Contact ü¶Ö", Flag="AvoidEye", CurrentValue=Toggles.AvoidEye, Callback=function(v) Toggles.AvoidEye=v end})
Main:CreateToggle({Name="Auto Reply (pls‚Üíno)", Flag="AutoReply", CurrentValue=Toggles.AutoReply, Callback=function(v) Toggles.AutoReply=v end})

-- Sliders
Settings:CreateSlider({Name="Avoid Distance", Flag="AvoidDist", Range={5,60}, Increment=1, Suffix="studs", CurrentValue=avoidDist, Callback=function(v) avoidDist=v end})
Settings:CreateSlider({Name="Step Back Distance", Flag="BackDist", Range={5,40}, Increment=1, Suffix="studs", CurrentValue=backDist, Callback=function(v) backDist=v end})
Settings:CreateSlider({Name="Patrol Radius", Flag="PatrolRadius", Range={10,80}, Increment=1, Suffix="studs", CurrentValue=patrolRadius, Callback=function(v) patrolRadius=v end})
Settings:CreateSlider({Name="Patrol Segments (2‚Äì3)", Flag="PatrolSeg", Range={2,3}, Increment=1, CurrentValue=patrolSeg, Callback=function(v) patrolSeg=v end})
Settings:CreateSlider({Name="Patrol Pause", Flag="PatrolPause", Range={0,2}, Increment=0.1, Suffix="s", CurrentValue=patrolPause, Callback=function(v) patrolPause=v end})

-- Inputs
Settings:CreateInput({Name="Reply Keywords (comma)", Flag="ReplyKeys", PlaceholderText="plss,pls", Text=table.concat(replyKeys,","), Callback=function(text)
  local t = {}
  for w in string.gmatch(text or "", "[^,]+") do t[#t+1] = w:lower():gsub("^%s*(.-)%s*$","%1") end
  if #t>0 then replyKeys = t end
end})
Settings:CreateInput({Name="Reply Text", Flag="ReplyTxt", PlaceholderText="no", Text=replyTxt, Callback=function(text)
  if text and #text>0 then replyTxt = text end
end})

-- Load saved config (must be last)
Rayfield:LoadConfiguration()